<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - KeuanganKu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm position-sticky top-0 z-3">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" th:href="@{/dashboard}">ðŸ’° KeuanganKu</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link active" th:href="@{/dashboard}">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/transactions}">Transaksi</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/assets}">Aset</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/debts}">Utang</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/budgets}">Anggaran</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/reports}">Laporan</a></li>
                </ul>
                <div class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <i class="bi bi-person-circle"></i> Halo, <strong th:text="${user.name ?: #authentication.name}">User</strong>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" th:href="@{/profile}">Profil Saya</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <form th:action="@{/logout}" method="post" class="d-flex px-3">
                                    <button class="btn btn-danger btn-sm w-100" type="submit">Logout</button>
                                </form>
                            </li>
                        </ul>
                    </li>
                </div>
            </div>
        </div>
    </nav>

    <!-- Konten Utama -->
    <main class="container my-4">
        <!-- Baris Kartu Ringkasan -->
        <div class="row">
            <!-- Kartu Total Pemasukan BULAN INI -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-success text-uppercase mb-1">Pemasukan Bulan Ini</div>
                                <div class="h5 mb-0 fw-bold text-gray-800"
                                    th:text="${#numbers.formatCurrency(totalPemasukanBulanIni)}">Rp0</div>
                            </div>
                            <div class="col-auto"><i class="bi bi-arrow-down-circle-fill fs-2 text-gray-300"></i></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Kartu Total Pengeluaran BULAN INI -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-warning text-uppercase mb-1">Pengeluaran Bulan Ini
                                </div>
                                <div class="h5 mb-0 fw-bold text-gray-800"
                                    th:text="${#numbers.formatCurrency(totalPengeluaranBulanIni)}">Rp0</div>
                            </div>
                            <div class="col-auto"><i class="bi bi-arrow-up-circle-fill fs-2 text-gray-300"></i></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Kartu Total Aset -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-primary text-uppercase mb-1">Total Aset</div>
                                <div class="h5 mb-0 fw-bold text-gray-800"
                                    th:text="${#numbers.formatCurrency(totalAset)}">Rp0</div>
                            </div>
                            <div class="col-auto"><i class="bi bi-wallet2 fs-2 text-gray-300"></i></div>
                        </div>
                    </div>
                </div>
            </div>

                <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-info text-uppercase mb-1">Total Cicilan Bulan Ini</div>
                                <div class="h5 mb-0 fw-bold text-gray-800" th:text="${#numbers.formatCurrency(totalCicilanBulanIni)}">Rp0</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-calendar-check-fill fs-2 text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kartu Total Utang -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-danger shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs fw-bold text-danger text-uppercase mb-1">Total Utang</div>
                                <div class="h5 mb-0 fw-bold text-gray-800"
                                    th:text="${#numbers.formatCurrency(totalUtang)}">Rp0</div>
                            </div>
                            <div class="col-auto"><i class="bi bi-credit-card-2-front fs-2 text-gray-300"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bagian Analisis Kesehatan Keuangan -->
        <div class="row mt-2">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header fw-bold text-primary">Analisis Kesehatan Keuangan</div>
                    <div class="card-body">
                        <!-- Metrik 1: Rasio Utang terhadap Aset -->
                        <div class="mb-4">
                            <h6 class="fw-bold">Rasio Utang terhadap Aset <span class="badge rounded-pill"
                                    th:classappend="${debtToAssetMetric.colorClass}"
                                    th:text="${debtToAssetMetric.status}"></span></h6>
                            <p class="small text-muted mb-1">Menunjukkan seberapa besar aset Anda yang dibiayai utang.
                                Semakin rendah, semakin baik.</p>
                            <div class="progress" role="progressbar" style="height: 20px;">
                                <div class="progress-bar" th:classappend="${debtToAssetMetric.colorClass}"
                                    th:style="'width: ' + ${debtToAssetMetric.valueAsPercentage()} + '%'"
                                    th:text="${debtToAssetMetric.valueAsPercentage()} + '%'"></div>
                            </div>
                        </div>
                        <!-- Metrik 2: Tingkat Tabungan -->
                        <div>
                            <h6 class="fw-bold">Tingkat Tabungan (Savings Rate) <span class="badge rounded-pill"
                                    th:classappend="${savingsRateMetric.colorClass}"
                                    th:text="${savingsRateMetric.status}"></span></h6>
                            <p class="small text-muted mb-1">Menunjukkan persentase pemasukan yang berhasil Anda simpan.
                                Semakin tinggi, semakin baik.</p>
                            <div class="progress" role="progressbar" style="height: 20px;">
                                <div class="progress-bar" th:classappend="${savingsRateMetric.colorClass}"
                                    th:style="'width: ' + ${savingsRateMetric.valueAsPercentage()} + '%'"
                                    th:text="${savingsRateMetric.valueAsPercentage()} + '%'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header fw-bold text-primary">Pelacakan Anggaran Bulan Ini</div>
                    <div class="card-body">
                        <!-- Pesan jika belum ada anggaran -->
                        <div th:if="${#lists.isEmpty(budgetInfos)}" class="text-center text-muted p-3">
                            <p class="mb-1">Anda belum mengatur anggaran untuk bulan ini.</p>
                            <a th:href="@{/budgets}" class="btn btn-sm btn-outline-primary">Atur Anggaran Sekarang</a>
                        </div>
                        <!-- Daftar progress bar jika ada anggaran -->
                        <div th:unless="${#lists.isEmpty(budgetInfos)}">
                            <div th:each="info : ${budgetInfos}" class="mb-4">
                                <div class="d-flex justify-content-between">
                                    <h6 class="fw-bold" th:text="${info.budget.category}"></h6>
                                    <span class="fw-bold"
                                        th:text="${#numbers.formatCurrency(info.spentAmount)} + ' / ' + ${#numbers.formatCurrency(info.budget.amount)}"></span>
                                </div>
                                <div class="progress" role="progressbar" style="height: 20px;">
                                    <div class="progress-bar" th:classappend="${info.progressBarColor}"
                                        th:style="'width: ' + ${info.percentageSpent} + '%'"
                                        th:text="${info.percentageSpent} + '%'"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Baris Grafik -->
        <div class="row mt-4">
            <div class="col-lg-12">
                <div class="card shadow-sm">
                    <div class="card-header fw-bold text-primary">Grafik Pengeluaran per Kategori</div>
                    <div class="card-body d-flex justify-content-center align-items-center" style="min-height: 350px;">
                        <canvas id="myPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header fw-bold text-primary">
                        <i class="bi bi-lightbulb-fill"></i> Rekomendasi Untuk Anda
                    </div>
                    <div class="card-body">
                        <!-- Pesan jika tidak ada rekomendasi -->
                        <div th:if="${#lists.isEmpty(recommendations)}" class="text-center p-3">
                            <p class="mb-1">Kondisi keuangan Anda terpantau baik! Terus pertahankan kebiasaan positif
                                ini.</p>
                        </div>

                        <!-- Menampilkan setiap rekomendasi dinamis -->
                        <div th:unless="${#lists.isEmpty(recommendations)}">
                            <div th:each="rec : ${recommendations}" class="alert" th:classappend="${rec.colorClass}"
                                role="alert">
                                <h5 class="alert-heading" th:text="${rec.title}"></h5>
                                <p th:text="${rec.message}"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:src="@{/js/dashboard.js}"></script>
</body>

</html>